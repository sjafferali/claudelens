# ClaudeLens Data Model Documentation

## Overview

This document provides a comprehensive overview of the ClaudeLens MongoDB data model, with special attention to field naming conventions and relationships between collections. The system uses MongoDB as its primary datastore with collections for projects, sessions, messages, prompts, and AI settings.

## Key Naming Conventions

### Understanding ID Fields

The data model uses different types of ID fields that serve distinct purposes:

1. **`_id` (MongoDB ObjectId)**: The internal MongoDB document identifier
   - Always a BSON ObjectId
   - Automatically generated by MongoDB
   - Used for internal database operations and references

2. **`sessionId` (String)**: The external Claude session identifier
   - A string UUID from Claude's system
   - NOT a MongoDB ObjectId
   - Used to group messages from the same Claude conversation

3. **`projectId` (ObjectId)**: Reference to a project document
   - Always a BSON ObjectId
   - Foreign key to the projects collection

4. **`uuid` (String)**: Claude's message identifier
   - A string UUID from Claude's system
   - Unique identifier for each message from Claude

## Collections

### 1. Projects Collection

Represents a Claude project workspace, typically corresponding to a directory where Claude was run.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "name": String,                 // Project name (e.g., "my-app")
  "path": String,                 // File system path (e.g., "/Users/john/projects/my-app")
  "description": String?,         // Optional project description
  "createdAt": DateTime,          // When project was first seen
  "updatedAt": DateTime,          // Last modification time
  "stats": {                      // Computed statistics
    "message_count": Number,      // Total messages in project
    "session_count": Number       // Total sessions in project
  }
}
```

**Key Points:**
- Projects are automatically created during message ingestion
- The `path` field is unique and used for deduplication
- Stats are computed dynamically, not stored

### 2. Sessions Collection

Represents a single Claude conversation session.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "sessionId": String,           // Claude's session identifier (NOT an ObjectId!)
  "projectId": ObjectId,         // Reference to projects._id
  "startedAt": DateTime,         // Session start time
  "endedAt": DateTime?,          // Session end time (null if ongoing)
  "messageCount": Number,        // Number of messages in session
  "totalCost": Decimal128,       // Total cost in USD
  "summary": String?,            // Auto-generated session summary
  "createdAt": DateTime,         // Database record creation
  "updatedAt": DateTime,         // Last update time

  // Additional computed fields (not always present)
  "toolsUsed": Number?,          // Number of tool uses
  "totalTokens": Number?,        // Total tokens consumed
  "inputTokens": Number?,        // Input tokens
  "outputTokens": Number?        // Output tokens
}
```

**Key Points:**
- `sessionId` is a STRING from Claude, not a MongoDB ObjectId
- `projectId` is an ObjectId reference to projects collection
- Sessions belong to exactly one project
- Cost is stored as Decimal128 for precision

### 3. Messages Collection

Stores individual messages from Claude conversations, including user inputs, assistant responses, and tool interactions.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "uuid": String,                // Claude's message UUID
  "sessionId": String,           // Claude's session ID (matches sessions.sessionId)
  "type": String,                // Message type: "user", "assistant", "tool_use", "tool_result"
  "timestamp": DateTime,         // When message was created

  // Hierarchy fields
  "parentUuid": String?,         // Parent message UUID (for threading)
  "isSidechain": Boolean,        // True for tool_use/tool_result messages

  // Content fields
  "content": String?,            // Human-readable message content
  "message": Object?,            // Raw message data from Claude
  "messageData": Object?,        // Structured message data

  // Context fields
  "cwd": String?,                // Working directory
  "version": String?,            // Claude version
  "gitBranch": String?,          // Git branch if applicable
  "userType": String?,           // User type classification

  // Assistant-specific fields
  "model": String?,              // Model used (e.g., "claude-3-opus")
  "costUsd": Decimal128?,        // Cost for this message
  "durationMs": Number?,         // Response time in milliseconds
  "requestId": String?,          // Claude API request ID
  "usage": Object?,              // Token usage details

  // Tool-specific fields
  "toolUseResult": Object?,      // Result of tool execution

  // Summary fields
  "summary": String?,            // Message summary
  "leafUuid": String?,           // UUID of leaf message in thread

  // Metadata
  "contentHash": String,         // SHA256 hash for deduplication
  "metadata": Object?,           // Additional metadata
  "createdAt": DateTime          // Database record creation
}
```

**Key Points:**
- `sessionId` is a STRING that matches sessions.sessionId (NOT an ObjectId reference)
- Messages do NOT have a direct projectId field (accessed through session)
- Tool interactions are stored as separate messages with `isSidechain: true`
- Parent-child relationships use `parentUuid` (string), not ObjectId references

### 4. Prompts Collection

Stores reusable prompt templates with version history.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "name": String,                // Prompt name
  "description": String?,        // Description
  "content": String,             // Template with {{variables}}
  "variables": [String],         // Extracted variable names
  "tags": [String],              // Categorization tags
  "folderId": ObjectId?,         // Reference to prompt_folders._id
  "version": String,             // Semantic version (e.g., "1.0.0")
  "versions": [{                 // Version history
    "version": String,
    "content": String,
    "variables": [String],
    "changeLog": String,
    "createdAt": DateTime,
    "createdBy": String
  }],

  // Sharing settings
  "visibility": String,          // "private", "team", or "public"
  "sharedWith": [String],        // User IDs for sharing
  "publicUrl": String?,          // Public sharing URL

  // Statistics
  "useCount": Number,            // Times used
  "lastUsedAt": DateTime?,       // Last usage
  "avgResponseTime": Number?,    // Average response time
  "successRate": Number?,        // Success percentage

  // Metadata
  "createdAt": DateTime,
  "updatedAt": DateTime,
  "createdBy": String,
  "isStarred": Boolean          // User favorite flag
}
```

**Key Points:**
- `folderId` is an ObjectId reference to prompt_folders collection
- Variables are automatically extracted from content using {{variable}} syntax
- Version history is embedded (last 10 versions kept)

### 5. Prompt Folders Collection

Organizes prompts into a hierarchical folder structure.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "name": String,                // Folder name
  "parentId": ObjectId?,         // Reference to parent folder._id
  "createdAt": DateTime,
  "updatedAt": DateTime,
  "createdBy": String
}
```

### 6. AI Settings Collection

Stores AI configuration and API settings.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "api_key_encrypted": String,   // Encrypted OpenAI API key
  "model": String,               // Default model (e.g., "gpt-4")
  "endpoint": String?,           // Custom endpoint URL
  "enabled": Boolean,            // Feature flag
  "usage_stats": {               // Usage tracking
    "total_generations": Number,
    "total_tokens": Number,
    "total_cost": Number
  },
  "created_at": DateTime,
  "updated_at": DateTime
}
```

### 7. Generation Templates Collection

Templates for AI-powered content generation.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "name": String,                // Template name
  "description": String?,
  "system_prompt": String,       // System instructions
  "user_prompt_template": String,// User prompt template
  "variables": [String],         // Template variables
  "is_default": Boolean,         // Default template flag
  "category": String?,           // Template category
  "created_at": DateTime,
  "updated_at": DateTime
}
```

### 8. Generation Logs Collection

Tracks AI generation usage for analytics and billing.

```javascript
{
  "_id": ObjectId,               // MongoDB document ID
  "operation": String,           // Operation type
  "model": String,               // Model used
  "prompt_tokens": Number,       // Input tokens
  "completion_tokens": Number,   // Output tokens
  "total_tokens": Number,        // Total tokens
  "estimated_cost": Number,      // Cost estimate
  "request_data": Object,        // Request details
  "response_data": Object?,      // Response details
  "error": String?,              // Error message if failed
  "duration_ms": Number,         // Processing time
  "created_at": DateTime
}
```

## Relationships and References

### Primary Relationships

1. **Project → Sessions** (One-to-Many)
   - Sessions reference projects via `projectId` (ObjectId)
   - A project can have multiple sessions
   - Deleting a project cascades to delete all sessions

2. **Session → Messages** (One-to-Many)
   - Messages reference sessions via `sessionId` (String)
   - A session contains multiple messages
   - Note: This uses sessionId STRING, not ObjectId reference

3. **Message → Message** (Parent-Child)
   - Messages reference parent via `parentUuid` (String)
   - Forms conversation threads
   - Tool uses create child messages

4. **Prompt → Folder** (Many-to-One)
   - Prompts reference folders via `folderId` (ObjectId)
   - Folders can be nested via `parentId`

### Important Distinctions

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| `_id` | ObjectId | MongoDB document ID | `ObjectId("507f1f77bcf86cd799439011")` |
| `sessionId` | String | Claude session identifier | `"session_abc123def456"` |
| `projectId` | ObjectId | Reference to project | `ObjectId("507f1f77bcf86cd799439012")` |
| `uuid` | String | Claude message ID | `"msg_xyz789ghi012"` |
| `parentUuid` | String | Parent message UUID | `"msg_parent123"` |
| `folderId` | ObjectId | Reference to folder | `ObjectId("507f1f77bcf86cd799439013")` |

## Indexes

### Messages Collection Indexes
- `sessionId` - For session queries
- `timestamp` - For time-based sorting
- `uuid` - For message lookups
- `type, timestamp` - For type-filtered queries
- Text index on `content` - For search

### Sessions Collection Indexes
- `sessionId` - Unique index for Claude session ID
- `projectId` - For project queries
- `startedAt` - For time-based queries
- Text index on `summary` - For search

### Projects Collection Indexes
- `path` - Unique index for deduplication
- Text index on `name, description` - For search

### Prompts Collection Indexes
- `folderId` - For folder queries
- `tags` - For tag filtering
- `isStarred` - For favorites
- Text index on `name, content, description` - For search

## Data Flow

1. **Ingestion**: Messages arrive from Claude with sessionId (string) → Create/update project and session → Store messages
2. **Querying**: Frontend requests use MongoDB _id or sessionId → Backend converts to appropriate ObjectId when needed
3. **Deletion**: Project deletion cascades through sessions to messages using ObjectId and sessionId relationships

## Migration Considerations

When working with this data model:

1. Always validate ObjectId fields before queries
2. Remember sessionId and uuid are strings, not ObjectIds
3. Use proper type conversion in application code
4. Maintain referential integrity manually (MongoDB doesn't enforce foreign keys)
5. Cost fields use Decimal128 for precision
6. Timestamps should be stored in UTC

## Common Queries

### Find all messages for a project
```javascript
// First, get all session IDs for the project
const sessionIds = await db.sessions.distinct("sessionId", {
  projectId: ObjectId(projectId)
});

// Then, get all messages for those sessions
const messages = await db.messages.find({
  sessionId: { $in: sessionIds }
});
```

### Find message with context
```javascript
// Get a message and its thread
const message = await db.messages.findOne({
  uuid: messageUuid
});

// Get parent messages
const parents = [];
let currentUuid = message.parentUuid;
while (currentUuid) {
  const parent = await db.messages.findOne({
    uuid: currentUuid
  });
  if (parent) {
    parents.unshift(parent);
    currentUuid = parent.parentUuid;
  } else {
    break;
  }
}
```

## Notes on Data Integrity

1. **Cascade Deletion**: Project deletion must cascade to sessions and messages
2. **Orphan Prevention**: Always check for existing project/session before creating messages
3. **Deduplication**: Use contentHash field to prevent duplicate messages
4. **Cost Precision**: Always use Decimal128 for monetary values
5. **Time Zones**: All timestamps stored in UTC
